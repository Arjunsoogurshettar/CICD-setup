stage('Deploy and Push to DR EKS') {
    agent {
        label 'deploy'    // Runs on the Deploy agent
    }
    environment {
        AWS_ACCESS_KEY_ID     = credentials('aws-access-key-dr')
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-access-key-dr')
        AWS_DEFAULT_REGION    = 'us-west-2'  // Change to DR region
    }
    steps {
        script {
            sh 'curl -o jenkins-test-1.0.jar http://3.111.168.233:8081/artifactory/libs-release/com/example/jenkins-test/1.0/jenkins-test-1.0.jar'

            sh '''
                aws ecr get-login-password --region ${AWS_DEFAULT_REGION} | docker login --username AWS --password-stdin 123456789012.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com
                docker build -t sstest . 
                docker tag sstest:latest 123456789012.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com/sstest:latest
                docker push 123456789012.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com/sstest:latest

                # Update kubeconfig for DR EKS
                aws eks update-kubeconfig --region us-west-2 --name dr-cluster-eksctl
                kubectl apply -f manifest.yaml
                sleep 10
                kubectl get pods -n ss-dev
                kubectl get svc -n ss-dev
            '''
        }
    }
}
